<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Início - Sistema de Adoção</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
</head>
<body>

    <nav class="top-nav">
        {% if current_user.is_authenticated %}
            <span>Bem-vindo, {{ current_user.nome }}!</span>  |
            <a href="{{ url_for('home') }}">Inicio</a>  |
            <a href="{{ url_for('sobre') }}">Sobre nós</a>  |
            <a href="{{ url_for('auth.denunciarAnimais') }}">Denunciar Animal</a>  |
            <a href="{{ url_for('auth.cadastrar_ponto') }}">Cadastrar Ponto de Adoção</a>  |
            <a href="{{ url_for('auth.logout') }}">Logout</a>
        {% else %}
            <a href="{{ url_for('home') }}">Inicio</a>  |
            <a href="{{ url_for('sobre') }}">Sobre nós</a>  |
            <a href="{{ url_for('auth.login') }}">Login</a>  |
            <a href="{{ url_for('auth.register') }}">Cadastro</a>
        {% endif %}
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul>
          {% for category, message in messages %}
            <li class="flash {{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <h1>Bem-vindo ao Sistema de Adoção e Denúncia de Animais</h1>

    <div id="map-container">
        <div id="map"></div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" data-tab="denuncias">Denúncias</button>
        <button class="tab-btn" data-tab="adocoes">Pontos de Adoção</button>
    </div>

    <!-- Filtro por Data -->
    <div class="filter-container">
    <label for="start-date">De:</label>
    <input type="date" id="start-date">

    <label for="end-date">Até:</label>
    <input type="date" id="end-date">

    <label for="min-qty">Qtd. mínima:</label>
    <input type="number" id="min-qty" min="0" placeholder="0">

    <label for="max-qty">Qtd. máxima:</label>
    <input type="number" id="max-qty" min="0" placeholder="∞">

    <button id="filter-btn">Filtrar</button>
    <button id="reset-btn">Limpar</button>
</div>
   
<section id="denuncias" class="tab-content active">
  <div class="cards-container">
    {% for d in denuncias %}
      <div class="card-item" data-date="{{ d.criado_em }}" data-quantity="{{ d.quantidade }}">
        <div class="card-header">
          <div class="card-date">{{ d.criado_em.strftime('%d/%m/%Y') }}</div>
        </div>
        <div class="card-content">
          <div class="card-detail">
            <span class="detail-label">Animal</span>
            <span class="detail-value">{{ d.tipo_animal }}</span>
          </div>
          <div class="card-detail">
            <span class="detail-label">Quantidade</span>
            <span class="detail-value">{{ d.quantidade }}</span>
          </div>
          <div class="card-location">
            <span class="detail-label">Localização</span>
            <a href="#" class="coord-link" data-lat="{{ d.cordenada.split(',')[0] }}" data-lng="{{ d.cordenada.split(',')[1] }}">
              Ver no mapa
            </a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<section id="adocoes" class="tab-content">
  <div class="cards-container">
    {% for p in pontos %}
      <div class="card-item" data-date="{{ p.criado_em }}" data-quantity="{{ p.quantidade_disponivel }}">
        <div class="card-header">
          <h3 class="local-name" data-lat="{{ p.cordenada.split(',')[0] }}" data-lng="{{ p.cordenada.split(',')[1] }}">
            <a href="#" class="coord-link" data-lat="{{ p.cordenada.split(',')[0] }}" data-lng="{{ p.cordenada.split(',')[1] }}">
              {{ p.nome_local }}
            </a>
          </h3>
          <div class="card-date">{{ p.criado_em.strftime('%d/%m/%Y') }}</div>
        </div>
        <div class="card-content">
          <div class="card-detail">
            <span class="detail-label">Animal</span>
            <span class="detail-value">{{ p.tipo_animal }}</span>
          </div>
          <div class="card-detail">
            <span class="detail-label">Disponíveis</span>
            <span class="detail-value">{{ p.quantidade_disponivel }}</span>
          </div>
          <div class="card-location">
            <span class="detail-label">Localização</span>
            <a href="#" class="coord-link" data-lat="{{ p.cordenada.split(',')[0] }}" data-lng="{{ p.cordenada.split(',')[1] }}">
              Ver no mapa
            </a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>
    <script>
    document.getElementById("filter-btn").addEventListener("click", () => {
        const start = document.getElementById("start-date").value;
        const end = document.getElementById("end-date").value;
        const minQty = document.getElementById("min-qty").value;
        const maxQty = document.getElementById("max-qty").value;
        const cards = document.querySelectorAll(".card-item");

        const today = new Date(); // data atual

        cards.forEach(card => {
            const cardDate = new Date(card.getAttribute("data-date"));
            const startDate = start ? new Date(start) : null;
            const endDate = end ? new Date(end + "T23:59:59") : null; // inclui o dia inteiro

            // pegar quantidade no card
            let qtyText = card.textContent.match(/Quantidade:\s*(\d+)/);
            let qty = qtyText ? parseInt(qtyText[1]) : 0;

            const min = minQty ? parseInt(minQty) : null;
            const max = maxQty ? parseInt(maxQty) : null;

            let show = true;

            // FILTRO POR DATA
            if (startDate && !endDate) {
                if (cardDate < startDate || cardDate > today) show = false;
            } else if (!startDate && endDate) {
                if (cardDate > endDate) show = false;
            } else {
                if (startDate && cardDate < startDate) show = false;
                if (endDate && cardDate > endDate) show = false;
            }

            // FILTRO POR QUANTIDADE
            if (min !== null && qty < min) show = false;
            if (max !== null && qty > max) show = false;

            card.style.display = show ? "block" : "none";
        });
    });

    document.getElementById("reset-btn").addEventListener("click", () => {
        document.getElementById("start-date").value = "";
        document.getElementById("end-date").value = "";
        document.getElementById("min-qty").value = "";
        document.getElementById("max-qty").value = "";
        document.querySelectorAll(".card-item").forEach(card => {
            card.style.display = "block";
        });
    });
</script>

    <script>
        const denuncias = {{ denuncias | tojson }};
        const pontos = {{ pontos | tojson }};
    </script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{{ url_for('static', filename='js/mapa.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs.js') }}"></script>

</body>
<footer>
  <p>Ícones feitos por <a href="https://www.flaticon.com/authors/berkahicon" title="berkahicon">berkahicon</a>
     de <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></p>
</footer>
</html>
